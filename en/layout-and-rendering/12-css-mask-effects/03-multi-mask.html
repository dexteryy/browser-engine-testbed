<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>12-3 Multi-layer masking and compositing (optional)</title>
  <link rel="stylesheet" href="./assets/common.css">
  <style>
  .demo{display:flex;gap:18px;align-items:flex-start;}
  .demo .box{width:420px;height:260px;border-radius:12px;}
  .layers{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container">
      <h1 class="title">12-3 Multi-layer masking and compositing (optional)</h1>
      <p class="desc">Try multiple mask layers and specify mask-composite operation; if the browser does not support it, it will fall back to the default overlay.</p>
    </div>
  </div>

  <div class="toolbar">
    <div class="container">
      <div class="control">
        <label>Default combination</label>
        <select id="preset">
          <option value="add">Add (overlap union)</option>
          <option value="intersect">intersect (intersect)</option>
          <option value="subtract">Subtraction (previous layer minus next layer)</option>
          <option value="exclude">Symmetric difference (XOR)</option>
        </select>
      </div>
      <div class="control">
        <label>shape A(center)</label>
        <select id="shapeA">
          <option value="circle">round</option>
          <option value="star">star shape</option>
          <option value="radial">radial gradient</option>
        </select>
      </div>
      <div class="control">
        <label>shape B(can be offset)</label>
        <select id="shapeB">
          <option value="ring">ring</option>
          <option value="star">star shape</option>
          <option value="linear">linear gradient</option>
        </select>
      </div>
      <div class="control">
        <label>B offset / size</label>
        <div class="value">X <input id="bx" type="range" min="0" max="100" value="60"> <span id="bxv">60%</span></div>
        <div class="value">Y <input id="by" type="range" min="0" max="100" value="40"> <span id="byv">40%</span></div>
        <div class="value">size <input id="bs" type="range" min="40" max="160" value="100"> <span id="bsv">100%</span></div>
      </div>
      <div class="status">
        <span class="badge" id="support">mask-composite: Under detection...</span>
      </div>
    </div>
  </div>

  <div class="section container">
    <div class="demo">
      <div class="card">
        <h3>Multi-layered mask elements</h3>
        <div class="box mask-target checker" id="target">
          <div class="transparent-backdrop"></div>
          <div class="photo"></div>
        </div>
        <p class="small-note">If not supported <code>mask-composite</code>,The default cascading display is displayed; it can still be used to observe compatible policies.</p>
      </div>
      <div class="card" style="flex:1">
        <h3>efficient CSS</h3>
        <pre><code id="cssOut"></code></pre>
        <p class="footer-note">Note: different browsers/version pair <code>mask-composite</code> Support may vary; please refer to the latest Chrome Behavior shall prevail.</p>
      </div>
    </div>
  </div>

  <div class="section container">
    <div class="explain">
      <h2>Explanation</h2>
      <ul class="list">
        <li><strong>Test objectives:</strong>Evaluate the rendering performance of multi-mask layer overlay and Boolean composition.</li>
        <li><strong>How to use:</strong>Switch preset, shapeandoffsetquantity,Observe changes in the visible area under different composition relationships.</li>
        <li><strong>Inspection method:</strong>exist DevTools turn on <span class="kbd">Layer borders</span>,Checks whether independent composition layers are generated.</li>
      </ul>
    </div>
  </div>

  <script src="./assets/common.js"></script>
  <script>
    const {byId, on, cssSupports, maskSources, applyMaskStyles} = window.MaskUtils;
    const t = byId('target'); const cssOut = byId('cssOut');
    const preset = byId('preset'), shapeA = byId('shapeA'), shapeB = byId('shapeB');
    const bx = byId('bx'), by = byId('by'), bs = byId('bs');
    const bxv = byId('bxv'), byv = byId('byv'), bsv = byId('bsv');
    const supportStandard = cssSupports('mask-composite', 'intersect');
    const supportWebkit = cssSupports('-webkit-mask-composite', 'source-in');
    const supportLabel = supportStandard
      ? 'mask-composite: support'
      : (supportWebkit ? '-webkit-mask-composite: Support (old value syntax)' : 'mask-composite: Nosupport(will revert to the default overlay)');
    byId('support').textContent = supportLabel;

    function imgFor(value){
      if (value === 'radial'){
        return `radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 45%, rgba(0,0,0,0) 70%)`;
      }
      if (value === 'linear'){
        return `linear-gradient(135deg, rgba(0,0,0,1) 50%, rgba(0,0,0,0) 70%)`;
      }
      if (value === 'circle') return `url('${maskSources.circle}')`;
      if (value === 'star') return `url('${maskSources.star}')`;
      if (value === 'ring') return `url('${maskSources.ring}')`;
      return value;
    }

    function apply(){
      const a = imgFor(shapeA.value);
      const b = imgFor(shapeB.value);
      // Two-layer mask
      const sizeA = '100% 100%';
      const sizeB = `${bs.value}% ${bs.value}%`;
      const posA = '50% 50%';
      const posB = `${bx.value}% ${by.value}%`;
      const repeat = 'no-repeat, no-repeat';
      applyMaskStyles(t, {
        image: `${a}, ${b}`,
        mode: `alpha, alpha`,
        size: `${sizeA}, ${sizeB}`,
        position: `${posA}, ${posB}`,
        repeat
      });

      const compStd = `add, ${preset.value}`; // add | subtract | intersect | exclude
      const mapWebkit = { add: 'source-over', subtract: 'source-out', intersect: 'source-in', exclude: 'xor' };
      const compWebkit = `source-over, ${mapWebkit[preset.value] || 'source-over'}`;
      t.style.maskComposite = supportStandard ? compStd : '';
      t.style.webkitMaskComposite = supportWebkit ? compWebkit : '';

      cssOut.textContent = `mask-image: ${a}, ${b};
mask-mode: alpha, alpha;
mask-size: ${sizeA}, ${sizeB};
mask-position: ${posA}, ${posB};
mask-repeat: ${repeat};
${supportStandard ? `mask-composite: ${compStd};` : (supportWebkit ? `-webkit-mask-composite: ${compWebkit};` : '/* mask-composite Nosupport:Regressed to default overlay */')}`;
      bxv.textContent = bx.value + '%';
      byv.textContent = by.value + '%';
      bsv.textContent = bs.value + '%';
    }

    [preset, shapeA, shapeB, bx, by, bs].forEach(el => on(el, 'input', apply));
    apply();
  </script>
</body>
</html>
