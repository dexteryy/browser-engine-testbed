<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>跨路由 View Transitions｜列表页</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .route-note {
        color: var(--muted);
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <h1>View Transitions｜跨路由切换（列表）</h1>
      <p>从缩略图列表导航到详情页，验证跨文档快照合成与层数。</p>
    </header>
    <main class="page">
      <section class="toolbar">
        <div class="group">
          <span class="chip">模式：跨路由</span>
          <span class="chip" id="vt-support">View Transitions: 检测中…</span>
        </div>
        <div class="group route-note">
          点击缩略图触发 document.startViewTransition + location 跳转。
        </div>
        <button class="btn" id="shuffle">随机排序</button>
      </section>

      <section class="panel">
        <h2 class="section-title">列表页（/cross-route-list.html）</h2>
        <p class="note">
          缩略图与详情页使用相同的 view-transition-name（photo-N）；在 DevTools
          → Layers 中检查跨页面快照复用。
        </p>
        <div class="grid" id="grid"></div>
      </section>

      <section class="panel explain">
        <h3 class="section-title">使用说明</h3>
        <div>
          1）点击缩略图进入详情页，Performance 录制跳转链路，关注 Snapshot
          capture 与 Composite。
        </div>
        <div>2）返回列表页时同样记录帧率，比较与单页模式的差异。</div>
        <div>3）可多次随机排序列表，观察大量元素重新捕获时的合成层变化。</div>
      </section>
    </main>

    <script>
      const vtSupport = document.getElementById("vt-support");
      const grid = document.getElementById("grid");
      const shuffleBtn = document.getElementById("shuffle");
      const supportsViewTransition =
        typeof document.startViewTransition === "function";
      vtSupport.textContent = supportsViewTransition
        ? "View Transitions: 可用"
        : "View Transitions: 不支持，使用静态跳转";

      const items = Array.from({ length: 18 }, (_, i) => ({
        id: i + 1,
        title: `图像 ${i + 1}`,
        tone: (i * 37) % 360,
      }));

      function render() {
        grid.innerHTML = "";
        items.forEach(item => {
          const card = document.createElement("button");
          card.className = "thumb";
          card.dataset.id = item.id;
          const img = document.createElement("div");
          img.className = "img";
          img.style.viewTransitionName = `photo-${item.id}`;
          img.style.background = `linear-gradient(135deg, hsl(${
            item.tone
          }, 80%, 58%), hsl(${(item.tone + 24) % 360}, 78%, 62%))`;
          img.textContent = item.id;
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.innerHTML = `<span>${item.title}</span><span>${
            160 + (item.id % 6) * 30
          }px</span>`;
          card.appendChild(img);
          card.appendChild(meta);
          card.addEventListener("click", () => goDetail(item.id));
          grid.appendChild(card);
        });
      }

      function goDetail(id) {
        const navigate = () => {
          const url = new URL(location.href);
          const segments = url.pathname.split("/");
          segments[segments.length - 1] = "cross-route-detail.html";
          url.pathname = segments.join("/");
          url.searchParams.set("id", id);
          window.location.href = url.toString();
        };
        if (!supportsViewTransition) {
          navigate();
          return;
        }
        document.startViewTransition(navigate);
      }

      shuffleBtn.addEventListener("click", () => {
        items.sort(() => Math.random() - 0.5);
        render();
      });

      render();
    </script>
  </body>
</html>
