<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>跨路由 View Transitions｜详情页</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="topbar">
    <h1>View Transitions｜跨路由切换（详情）</h1>
    <p>大图详情与列表页共享 view-transition-name，测试跨文档 morph。</p>
  </header>
  <main class="page">
    <section class="toolbar">
      <div class="group">
        <span class="chip">模式：跨路由</span>
        <span class="chip" id="vt-support">View Transitions: 检测中…</span>
      </div>
      <div class="group">
        <span class="chip" id="id-chip">ID: -</span>
      </div>
      <button class="btn primary" id="go-back">返回列表</button>
      <button class="btn" id="next">下一个</button>
    </section>

    <section class="panel">
      <div class="detail">
        <div class="hero" id="hero">
          <div class="label" id="hero-label">#</div>
        </div>
        <div class="info">
          <h2 class="section-title">详情页（/cross-route-detail.html?id=N）</h2>
          <p class="note">跨页面的 View Transitions 依赖浏览器捕获旧页面快照并在新页面上合成。</p>
        </div>
      </div>
    </section>

    <section class="panel explain">
      <h3 class="section-title">使用说明</h3>
      <div>1）检查 DevTools → Layers，确认 photo-N 的快照层大小与数量。</div>
      <div>2）在 Performance 中录制从列表到详情、再返回的完整链路，关注 Raster / Composite。</div>
      <div>3）尝试不同的 ID，观察快照捕获时间与内存占用差异。</div>
    </section>
  </main>

  <script>
    const params = new URLSearchParams(location.search);
    const id = Number(params.get('id')) || 1;
    const vtSupport = document.getElementById('vt-support');
    const hero = document.getElementById('hero');
    const heroLabel = document.getElementById('hero-label');
    const idChip = document.getElementById('id-chip');
    const supportsViewTransition = typeof document.startViewTransition === 'function';
    vtSupport.textContent = supportsViewTransition ? 'View Transitions: 可用' : 'View Transitions: 不支持，使用静态跳转';

    function applyHero(targetId) {
      const tone = (targetId * 37) % 360;
      hero.style.viewTransitionName = `photo-${targetId}`;
      hero.style.background = `linear-gradient(135deg, hsl(${tone}, 80%, 56%), hsl(${(tone + 26) % 360}, 78%, 60%))`;
      heroLabel.textContent = `详情 ${targetId}`;
      idChip.textContent = `ID: ${targetId}`;
    }

    function goList(targetId) {
      const navigate = () => {
        const url = new URL(location.href);
        const segments = url.pathname.split('/');
        segments[segments.length - 1] = 'cross-route-list.html';
        url.pathname = segments.join('/');
        if (targetId) {
          url.hash = `#from-${targetId}`;
        }
        window.location.href = url.toString();
      };
      if (!supportsViewTransition) {
        navigate();
        return;
      }
      document.startViewTransition(navigate);
    }

    document.getElementById('go-back').addEventListener('click', () => goList(id));
    document.getElementById('next').addEventListener('click', () => {
      const nextId = (id % 18) + 1;
      const navigate = () => {
        const url = new URL(location.href);
        url.searchParams.set('id', nextId);
        window.location.href = url.toString();
      };
      if (!supportsViewTransition) {
        navigate();
        return;
      }
      document.startViewTransition(navigate);
    });

    applyHero(id);
  </script>
</body>
</html>
